#!/usr/bin/env bash

# Improved script to copy only relevant files for the Arduino library
# Fixes TODO item #7: "Make sure that the copy_stuff_to_Arduino.sh script copies all relevant file for the Arduino library to work"

DEST_DIR="/Users/tom/Documents/Arduino/libraries/Servomotor"

# Resolve repo root (this script lives at repo root) and ensure predictable globbing
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_DIR="$SCRIPT_DIR"
shopt -s nullglob
cd "$REPO_DIR"

# Ensure destination directory exists
if [ ! -d "$DEST_DIR" ]; then
    echo "Creating destination directory: $DEST_DIR"
    mkdir -p "$DEST_DIR"
fi

# Clean destination directory (optional)
echo "Cleaning destination directory..."
rm -rf "$DEST_DIR"/*

# Define core files that need to be copied
CORE_FILES=(
    "Servomotor.cpp"
    "Servomotor.h"
    "Commands.h"
    "Communication.cpp"
    "Communication.h"
    "DataTypes.cpp"
    "DataTypes.h"
    "Utils.h"
    "AutoGeneratedUnitConversions.cpp"
    "AutoGeneratedUnitConversions.h"
    "library.properties"
    "README.md"
    "keywords.txt"
    "LICENSE"
)

# Create standard Arduino library directories
mkdir -p "$DEST_DIR/src"

# Copy implementation files (.cpp) to src directory only
# Copy header files (.h) to both root and src directory
echo "Copying library files..."
for FILE in "${CORE_FILES[@]}"; do
    if [ -f "$FILE" ]; then
        if [[ "$FILE" == *.cpp ]]; then
            # Copy .cpp files to src/ only
            cp "$FILE" "$DEST_DIR/src"
            echo "  ✅ $FILE (copied to src/)"
        elif [[ "$FILE" == *.h ]]; then
            # Copy .h files to both root and src/
            cp "$FILE" "$DEST_DIR/src"
            cp "$FILE" "$DEST_DIR"
            echo "  ✅ $FILE (copied to both root and src/)"
        elif [[ "$FILE" == "library.properties" || "$FILE" == "README.md" || "$FILE" == "LICENSE" || "$FILE" == "keywords.txt" ]]; then
            # These files go to root only
            cp "$FILE" "$DEST_DIR"
            echo "  ✅ $FILE (copied to root)"
        else
            # Other files go to src/
            cp "$FILE" "$DEST_DIR/src"
            echo "  ✅ $FILE (copied to src/)"
        fi
    else
        echo "  ❌ Warning: $FILE not found!"
    fi
done
mkdir -p "$DEST_DIR/examples"

# Autodiscover examples: any example_*.cpp at repo root
echo "Creating examples:"
FOUND=0
for SRC in "$REPO_DIR"/example_*.cpp; do
    [ -f "$SRC" ] || continue
    FOUND=1
    bn="$(basename "$SRC")"
    DIR="${bn%.cpp}"   # example name = filename without .cpp
    mkdir -p "$DEST_DIR/examples/$DIR"
    # Copy and rename the example to match directory name (Arduino sketch convention)
    cp "$SRC" "$DEST_DIR/examples/$DIR/$DIR.ino"
    echo "  ✅ Created example: $DIR from $bn"
done
if [ "$FOUND" -eq 0 ]; then
    echo "  ⚠️  No example_*.cpp files found in $REPO_DIR"
fi

echo "Done! Library copied to $DEST_DIR"
