# Project Overview

> **Documentation Note**: All project documentation is maintained in this README.md file. Whenever documentation is mentioned or requested, it refers to updates or additions to this file.

This project provides a C++ library for controlling servo motors on both embedded platforms (Arduino, ESP32-C3, etc.) and desktop environments (macOS, etc.). It includes:

- **Minimal Arduino emulator** for desktop testing (`ArduinoEmulator.h`).
- **Auto-generated unit conversions** for positions, velocities, times, temperatures, etc. (`AutoGeneratedUnitConversions.*`).
- **ServoMotor** class for motor control with advanced features like calibration, homing, e-stop, etc.
- **Example test programs**: `test_one_move.cpp`, `test_unit_conversions.cpp`, and `test_get_temperature.cpp`.

## Autogeneration of Parts of the Source Code

The library includes several Python scripts for code generation and maintenance:

- `generate_unit_conversion_code.py`: Generates unit conversion code from a JSON configuration
- `generate_command_code.py`: Generates command interface code

## File List and Descriptions

Below is an updated overview of the key files after renaming and restructuring:

| File                              | Description                                                                                                    |
|-----------------------------------|----------------------------------------------------------------------------------------------------------------|
| **ArduinoEmulator.h**             | Emulates Arduino's `Serial`, `delay()`, etc. for desktop builds.                                               |
| **AutoGeneratedUnitConversions.h / .cpp** | Functions to convert between various units (time, position, velocity, acceleration, etc.).                  |
| **Commands.h**                    | Autogenerated list of servo command IDs.                                                                       |
| **Communication.h / .cpp**        | Simple `Communication` class for sending/receiving commands (stubbed for testing).                             |
| **DataTypes.h / .cpp**            | Definitions of data type structures and bounds.                                                                |
| **Utils.h / .cpp**                | Helper utilities for endianness, packing, and general-purpose functionality.                                   |
| **Servomotor.h / .cpp**           | Main servo control class with features like calibration, homing, e-stop, etc.                                  |
| **test_one_move.cpp**             | Minimal example demonstrating a single trapezoid move (2 rotations over 3 seconds).                            |
| **test_unit_conversions.cpp**     | Desktop test verifying unit-conversion logic in `AutoGeneratedUnitConversions.*`.                              |
| **test_get_temperature.cpp**      | Example demonstrating how to read temperature from the motor.                                                  |
| **test_emergency_stop.cpp**       | Test for emergency stop functionality to ensure proper queue clearing and MOSFET disabling.                    |
| **test_move_with_velocity.cpp**   | Test for moveWithVelocity functionality with different units (rotations, degrees, encoder counts).             |
| **test_enable_disable_mosfets.cpp** | Test for enabling and disabling MOSFETs.                                                                     |
| **test_one_move_two_motors.cpp**  | Example demonstrating control of two motors simultaneously.                                                    |

## Architecture

1. **Unit Conversion Module**  
   - Centralizes all unit transformations in `AutoGeneratedUnitConversions.*`, ensuring consistency.
   - Supports various units:
     - Position: SHAFT_ROTATIONS, DEGREES, RADIANS, ENCODER_COUNTS
     - Time: SECONDS, MILLISECONDS, MINUTES, TIMESTEPS
   - Automatic conversion between user units and internal units (encoder counts and timesteps)

3. **Communication Module**  
   - `Communication.cpp` is a lightweight stub for sending commands and reading responses. It can be extended or replaced with a hardware-specific protocol (RS-485, UART, etc.).

4. **Servo Control Class**  
   - **`ServoMotor`** provides:
     - Automatic unit conversions between user units and internal units
     - Detailed debug output for all operations
     - Automatic serial port initialization
     - User-friendly interface for motor control

5. **Testing on Desktop vs. Arduino**  
   - If `ARDUINO` macros are defined, `<Arduino.h>` is used for real hardware.  
   - Otherwise, `ArduinoEmulator.h` provides stubs for Serial/delay so the same code builds on desktop.  
   - **Test programs** can be built via a standard C++ compiler on desktop or compiled as `.ino`/C++ sources on an Arduino platform.

## Installation

1. Download the Arduino library
2. Import it into the Arduino IDE
3. Include the library in your project by including "Servomotor.h"

## Example Usage

A typical Arduino `.ino` or `.cpp` file might look like:

```cpp
#include "Servomotor.h"

void setup() {
  Serial.begin(115200);  // For debug output

  // Create a ServoMotor instance
  ServoMotor motor('X', Serial1);  // Initialize with alias 'X' and Serial1 port
  
  // Set desired units (debug output will show the conversions)
  motor.setPositionUnit(PositionUnit::SHAFT_ROTATIONS);
  motor.setTimeUnit(TimeUnit::SECONDS);
  
  // Move 2 rotations over 3 seconds
  motor.trapezoidMove(2.0f, 3.0f);
}

void loop() {
  // ...
}
```

The debug output will show:
```
[Motor] Serial1 initialized at 230400 baud.
[Motor] setPositionUnit to SHAFT_ROTATIONS
[Motor] setTimeUnit to SECONDS
[Motor] trapezoidMove called.
  distance in chosen unit: 2
  time in chosen unit: 3
  -> distance in encoder_counts: 6.5536e+06
  -> duration in timesteps: 93750
```

### Important Usage Notes

**Using moveWithVelocity and moveWithAcceleration:**
When using moveWithVelocity or moveWithAcceleration, you must queue a second move to stop the motor properly. If the final velocity is not zero when the queue becomes empty, the motor will trigger a fatal error.

Example with moveWithVelocity:
```cpp
// First move at desired velocity
motor.moveWithVelocity(2.0f, 1.0f);  // 2 rotations/sec for 1 second

// Then queue a stop command
motor.moveWithVelocity(0.0f, 0.1f);  // 0 rotations/sec for 0.1 seconds
```

Example with moveWithAcceleration:
```cpp
// First move with positive acceleration
motor.moveWithAcceleration(2.0f, 1.0f);  // 2 rotations/sec² for 1 second

// Then queue a move with negative acceleration to stop
motor.moveWithAcceleration(-2.0f, 1.0f);  // -2 rotations/sec² for 1 second
```

### Testing

The library includes an Arduino emulator (`ArduinoEmulator.h` and `ArduinoEmulator.cpp`) that allows testing on desktop machines without actual hardware. Test files include:
- `test_unit_conversions.cpp`: Validates unit conversion accuracy
- `test_one_move.cpp`: Demonstrates unit conversions and motor control with detailed debug output
- `test_get_temperature.cpp`: Demonstrates reading temperature from the motor
- `test_emergency_stop.cpp`: Tests emergency stop functionality
- `test_move_with_velocity.cpp`: Tests moveWithVelocity functionality with different units (rotations, degrees, encoder counts) and includes comprehensive error checking
- `test_move_with_acceleration.cpp`: Tests moveWithAcceleration functionality with different units (rotations, degrees, radians, counts) and ensures proper stopping

The test framework (`test_framework.h` and `test_framework.cpp`) provides utilities for test reporting and error checking:
- `TEST_RESULT` macro: Reports test results with pass/fail status
- `checkMotorError` function: Checks for communication errors after motor commands and provides detailed error messages

To compile the test programs, use the provided build_tests.sh script which handles linking all necessary dependencies:

```bash
# Run the script to build all test programs
./build_tests.sh
```

The build_tests.sh script:
- Automatically builds ALL test programs in the project (does not accept parameters)
- Defines common source files needed by all tests
- Sets compiler flags (C++17 standard)
- Adds the REQUIRE_SERIAL_PORT flag for tests that need hardware communication
- Creates executable files with the same name as the test file (without the .cpp extension)

After running the script, you can execute any of the compiled test programs directly:
```bash
# Example: Run the emergency stop test
./test_emergency_stop
```

Each test program requires:
- C++17 standard (-std=c++17)
- REQUIRE_SERIAL_PORT define for hardware communication
- Linking with core library source files (ArduinoEmulator.cpp, Servomotor.cpp, etc.)

## TODO / Upcoming Changes

1. **Unit Conversion Tests to Implement (in order of priority)**
   - test_position_conversions.cpp - Test position unit conversions in:
     - trapezoidMove / trapezoidMoveRaw
     - goToPosition / goToPositionRaw
     - getPosition / getPositionRaw
     - getHallSensorPosition / getHallSensorPositionRaw
     - getComprehensivePosition / getComprehensivePositionRaw
     - Multimove
   
   - test_time_conversions.cpp - Test time unit conversions in:
     - getCurrentTime / getCurrentTimeRaw
     - trapezoidMove (duration parameter)
     - goToPosition (duration parameter)
     - moveWithVelocity (duration parameter)
   
   - test_velocity_conversions.cpp - Test velocity unit conversions in:
     - setMaximumVelocity / setMaximumVelocityRaw
     - moveWithVelocity / moveWithVelocityRaw
   
   - test_acceleration_conversions.cpp - Test acceleration unit conversions in:
     - setMaximumAcceleration / setMaximumAccelerationRaw
     - moveWithAcceleration / moveWithAccelerationRaw
   
   - test_current_conversions.cpp - Test current unit conversions in:
     - setMaximumMotorCurrent / setMaximumMotorCurrentRaw
   
   - test_temperature_conversions.cpp - Test temperature unit conversions in:
     - getTemperature / getTemperatureRaw
   
   - test_limits_conversions.cpp - Test limit unit conversions in:
     - setSafetyLimits / setSafetyLimitsRaw
     - setMaxAllowablePositionDeviation / setMaxAllowablePositionDeviationRaw

3. **Code Generation Enhancements**
   - Improve the autogeneration program that creates Servomotor.cpp and Servomotor.h
   - Make the code generation process more maintainable and flexible
   - Fix the conversion factors for current and voltage in the unit_conversions_M3.json file. Currently, these factors are missing or incorrect, resulting in a factor of 1.0 being used.

3. **Fix Some Problems With Servomotor.cpp, or Rather the Program that Generates this File, Which is generate_command_code.py**
   - getComprehensivePosition obviously will return zeros, which is wrong. Seems the autogeneration program does not know how to convert this
   - getMaxPidError has the same problem

4. **Fix the Multimove Function**
   - The moveList parameter currently is of type uint8_t, which looks wrong. We need to be able to give it a list of move velocities or accelerations (based on the bits in moveTypes) and the move times

5. ✅ **Rename ServomotorCommands.cpp to Servomotor.cpp** (Completed)
   - ✅ Renamed ServomotorCommands.h to Servomotor.h
   - ✅ Updated all tests and programs to use Servomotor.h instead
   - ✅ Updated the generate_command_code.py script to generate the updated filenames

6. **test_unit_conversions test fails, need to fix**
   - one test related to testAccelerationConversions() fails

## License

This library is released under the MIT License. See the LICENSE file for details.

## Author

Tom Rodinger (tom.rodinger@alumni.utoronto.ca)
