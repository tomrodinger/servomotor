# Project Overview

This project provides a C++ library for controlling servo motors on both embedded platforms (Arduino, ESP32-C3, etc.) and desktop environments (macOS, etc.). It includes:

- **Minimal Arduino emulator** for desktop testing (`ArduinoEmulator.h`).
- **Auto-generated unit conversions** for positions, velocities, times, temperatures, etc. (`AutoGeneratedUnitConversions.*`).
- **ServomotorCommands** class for motor control with advanced features like calibration, homing, e-stop, etc.
- **Example test programs**: `test_one_move.cpp`, `test_unit_conversions.cpp`, and `test_get_temperature.cpp`.

## Autogeneration of Parts of the Source Code

The library includes several Python scripts for code generation and maintenance:

- `generate_unit_conversion_code.py`: Generates unit conversion code from a JSON configuration
- `generate_command_code.py`: Generates command interface code

## File List and Descriptions

Below is an updated overview of the key files after renaming and restructuring:

| File                              | Description                                                                                                    |
|-----------------------------------|----------------------------------------------------------------------------------------------------------------|
| **ArduinoEmulator.h**             | Emulates Arduino's `Serial`, `delay()`, etc. for desktop builds.                                               |
| **AutoGeneratedUnitConversions.h / .cpp** | Functions to convert between various units (time, position, velocity, acceleration, etc.).                  |
| **Commands.h**                    | Autogenerated list of servo command IDs.                                                                       |
| **Communication.h / .cpp**        | Simple `Communication` class for sending/receiving commands (stubbed for testing).                             |
| **DataTypes.h / .cpp**            | Definitions of data type structures and bounds.                                                                |
| **Utils.h / .cpp**                | Helper utilities for endianness, packing, and general-purpose functionality.                                   |
| **ServomotorCommands.h / .cpp**   | Main servo control class with features like calibration, homing, e-stop, etc.                                  |
| **test_one_move.cpp**             | Minimal example demonstrating a single trapezoid move (2 rotations over 3 seconds).                            |
| **test_unit_conversions.cpp**     | Desktop test verifying unit-conversion logic in `AutoGeneratedUnitConversions.*`.                              |
| **test_get_temperature.cpp**      | Example demonstrating how to read temperature from the motor.                                                  |

## Architecture

1. **Unit Conversion Module**  
   - Centralizes all unit transformations in `AutoGeneratedUnitConversions.*`, ensuring consistency.
   - Supports various units:
     - Position: SHAFT_ROTATIONS, DEGREES, RADIANS, ENCODER_COUNTS
     - Time: SECONDS, MILLISECONDS, MINUTES, TIMESTEPS
   - Automatic conversion between user units and internal units (encoder counts and timesteps)

3. **Communication Module**  
   - `Communication.cpp` is a lightweight stub for sending commands and reading responses. It can be extended or replaced with a hardware-specific protocol (RS-485, UART, etc.).

4. **Servo Control Class**  
   - **`ServomotorCommands`** provides:
     - Automatic unit conversions between user units and internal units
     - Detailed debug output for all operations
     - Automatic serial port initialization
     - User-friendly interface for motor control

5. **Testing on Desktop vs. Arduino**  
   - If `ARDUINO` macros are defined, `<Arduino.h>` is used for real hardware.  
   - Otherwise, `ArduinoEmulator.h` provides stubs for Serial/delay so the same code builds on desktop.  
   - **Test programs** can be built via a standard C++ compiler on desktop or compiled as `.ino`/C++ sources on an Arduino platform.

## Installation

1. Download the Arduino library
2. Import it into the Arduino IDE
3. Include the library in your project by including "ServomotorCommands.h"

## Example Usage

A typical Arduino `.ino` or `.cpp` file might look like:

```cpp
#include "ServomotorCommands.h"

void setup() {
  Serial.begin(115200);  // For debug output

  // Create a ServoMotor instance
  ServoMotor motor('X', Serial1);  // Initialize with alias 'X' and Serial1 port
  
  // Set desired units (debug output will show the conversions)
  motor.setPositionUnit(PositionUnit::SHAFT_ROTATIONS);
  motor.setTimeUnit(TimeUnit::SECONDS);
  
  // Move 2 rotations over 3 seconds
  motor.trapezoidMove(2.0f, 3.0f);
}

void loop() {
  // ...
}
```

The debug output will show:
```
[Motor] Serial1 initialized at 230400 baud.
[Motor] setPositionUnit to SHAFT_ROTATIONS
[Motor] setTimeUnit to SECONDS
[Motor] trapezoidMove called.
  distance in chosen unit: 2
  time in chosen unit: 3
  -> distance in encoder_counts: 6.5536e+06
  -> duration in timesteps: 93750
```

### Testing

The library includes an Arduino emulator (`ArduinoEmulator.h` and `ArduinoEmulator.cpp`) that allows testing on desktop machines without actual hardware. Test files include:
- `test_unit_conversions.cpp`: Validates unit conversion accuracy
- `test_one_move.cpp`: Demonstrates unit conversions and motor control with detailed debug output
- `test_get_temperature.cpp`: Demonstrates reading temperature from the motor

To compile the test programs, use the provided build_tests.sh script which handles linking all necessary dependencies:
```bash
# The script compiles with required flags and source files, for example:
g++ -std=c++11 -DREQUIRE_SERIAL_PORT test_program.cpp ArduinoEmulator.cpp ServomotorCommands.cpp Communication.cpp Utils.cpp DataTypes.cpp AutoGeneratedUnitConversions.cpp -o test_program
```

Each test program requires:
- C++11 standard (-std=c++11)
- REQUIRE_SERIAL_PORT define for hardware communication
- Linking with core library source files (ArduinoEmulator.cpp, ServomotorCommands.cpp, etc.)

## TODO / Upcoming Changes

1. **Code Generation Enhancements**
   - Improve the autogeneration program that creates ServomotorCommands.cpp and ServomotorCommands.h
   - Make the code generation process more maintainable and flexible

## License

This library is released under the MIT License. See the LICENSE file for details.

## Author

Tom Rodinger (tom.rodinger@alumni.utoronto.ca)
