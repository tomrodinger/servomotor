# Servomotor Test Summary

## Test Files

| Filename                                                                       | Description                                                                                                                               | Module Used     | Obsolete | Prints PASS/FAIL |
| :----------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------- | :-------------- | :------- | :--------------- |
| `test_all_leds_on.py`                                                          | Resets devices and turns on all LEDs using a test mode command. Uses older `communication` module.                                        | `communication` | Yes      | No               |
| `test_communication_while_high_speed.py`                                       | Stress tests communication (ping) while the motor executes a high-speed accelerate-coast-decelerate profile. Uses `servomotor` library.     | `servomotor`    | No       | Yes              |
| `test_continuous_graphing.py`                                                  | Simple Matplotlib animation example, unrelated to motor control.                                                                          | `N/A`           | Yes      | No               |
| `test_enable_disable.py`                                                       | Repeatedly enables and disables motor MOSFETs for many iterations. Reliability test. Uses older `communication` module.                   | `communication` | Yes      | No               |
| `test_fast_short_move_with_velocity.py`                                        | Tests queuing and executing many short, fast moves using velocity control. Uses `servomotor` library.                                     | `servomotor`    | No       | Yes              |
| `test_get_comprehensive_position.py`                                           | Continuously polls and prints the comprehensive position (motor, hall, external encoder) for a specified motor. Uses `servomotor` library. | `servomotor`    | No       | No               |
| `test_getch.py`                                                                | Tests the `getch` terminal input utility using a mock motor class. No hardware interaction.                                               | `N/A`           | Yes      | No               |
| `test_glue_machine_rotation_matrix.py`                                         | Loads glue machine calibration/transform data, visualizes, and tests the transformation matrix accuracy. Application-specific.            | `N/A`           | No       | No               |
| `test_go_to_closed_loop_mode_and_spin_motor.py`                                | Tests closed-loop entry, performs moves, checks final position, and gathers success statistics based on phase angle. Uses older `communication` module. | `communication` | Yes      | No               |
| `test_go_to_closed_loop_mode_and_then_get_data_many_times.py`                  | Repeatedly enters closed-loop mode and reads/saves the internal data buffer (including Goertzel results). Data collection focus. Uses older `communication` module. | `communication` | Yes      | No               |
| `test_go_to_closed_loop_mode_plot_data.py`                                     | Reads and plots data logs generated by `test_go_to_closed_loop_mode_and_then_get_data_many_times.py`. Post-processing script.             | `N/A`           | Yes      | No               |
| `test_go_to_closed_loop_mode.py`                                               | Detailed closed-loop entry test: captures data, runs Python Goertzel comparison, logs results, generates histograms. Uses older `communication` module. | `communication` | Yes      | No               |
| `test_go_to_position.py`                                                       | Tests `go_to_position` command accuracy with position specified in different units (rotations, degrees, radians, counts). Uses `servomotor` library. | `servomotor`    | No       | Yes              |
| `test_gradual_speed_up.py`                                                     | Detects motors and gradually increases speed using `move_with_velocity` until max speed or error. Speed limit test. Uses `servomotor` library. | `servomotor`    | No       | No               |
| `test_homing.py`                                                               | Tests `homing` command accuracy with distance specified in different units and directions. Uses `servomotor` library.                     | `servomotor`    | No       | Yes              |
| `test_iterate_reset_and_enable.py`                                             | Repeatedly moves, disables, resets, enables. Reliability test. Uses older `communication` module. Potentially outdated/unclear.          | `communication` | Yes      | No               |
| `test_json_read.py`                                                            | Reads and prints contents of `motor_commands.json`. Basic utility script.                                                                 | `N/A`           | Yes      | No               |
| `test_motor_position_vs_hall_sensor_position_vs_external_encoder_position.py`  | Moves motor while sampling internal position, hall position, and external encoder position. Logs data and calculates deviations. Uses older `communication` module. | `communication` | Yes      | No               |
| `test_move_with_acceleration.py`                                               | Tests `move_with_acceleration` command accuracy with acceleration specified in different units. Uses `servomotor` library.                | `servomotor`    | No       | Yes              |
| `test_move_with_velocity.py`                                                   | Tests `move_with_velocity` command accuracy with velocity specified in different units. Uses `servomotor` library.                      | `servomotor`    | No       | Yes              |
| `test_ping.py`                                                                 | Basic communication test using `ping` command and verifying echoed data. Uses `servomotor` library.                                       | `servomotor`    | No       | Yes              |
| `test_random_speed_stress.py`                                                  | Complex stress test: detects, assigns aliases, pings, runs random speed moves on multiple motors, monitors errors, resets periodically. Uses `servomotor` library. | `servomotor`    | No       | No               |
| `test_safety_limit.py`                                                         | Low-level test using direct serial communication and special command to verify internal firmware motion calculations.                     | `serial`        | Yes      | Yes              |
| `test_servomotor_module_get_command_id.py`                                     | Unit test for the `servomotor.get_command_id()` function. No hardware interaction.                                                        | `servomotor`    | Yes      | Yes              |
| `test_servomotor_module.py`                                                    | Simple script using potentially outdated `servomotor.execute_command` to enable/reset. No verification.                                   | `servomotor`    | Yes      | No               |
| `test_set_velocity_to_specific_values.py`                                      | Moves specific, hardcoded motors at specific velocities. Debugging/characterization focus. Uses `servomotor` library.                     | `servomotor`    | No       | No               |
| `test_terminal_formatting.py`                                                  | Tests the `terminal_formatting` utility module. No hardware interaction.                                                                  | `N/A`           | Yes      | No               |
| `test_time_sync_multiple_devices.py`                                           | Tests time synchronization across multiple specified motors, reporting min/max error. Uses older `communication` module.                  | `communication` | Yes      | No               |
| `test_time_sync.py`                                                            | Tests time synchronization for a single specified motor, reporting error continuously. Uses older `communication` module.                 | `communication` | Yes      | No               |

## `test_set_device_alias.py`

This test verifies the device alias setting functionality using the `servomotor` library and the `M3` class. It covers:
- Setting a random valid alias (0â€“251) and verifying with device detection.
- Attempting to set invalid aliases (254, 253, 252) and confirming the device enters a fatal error state.
- Removing the alias (setting to 255) and confirming the device is detected with alias 255.

**Command-line arguments:**
- `-p`, `--port`: Serial port device name (required)
- `--bootloader`: Enter bootloader mode before running the test
- `--verbose`: Enable verbose output
- `-P`, `--PORT`: Show available ports and prompt for selection
- `--repeat N`: Repeat all test scenarios N times (default: 1)

After each repeat, the script prints the number of passes and failures for each test scenario. At the end, a grand summary is printed. The script exits with code 0 if all tests pass in all repeats, or 1 if any test fails.

Example usage:
```
python3 test_set_device_alias.py -p /dev/ttyUSB0 --repeat 5
```

## Best Practices for Writing Tests

Based on the modern tests using the `servomotor` module, follow these best practices:

*   **Use `servomotor` Library:** Import and utilize the `servomotor` library, specifically the `M3` class for motor control.
*   **Clear Initialization:** Instantiate the `M3` object, clearly defining units (`time_unit`, `position_unit`, `velocity_unit`, etc.).
*   **Command-Line Arguments:** Use `argparse` to handle common options like serial port (`-p`, `-P`), alias (`-a`), and verbosity (`-v`), making tests more flexible.
*   **Port Handling Order:** **Crucially**, ensure argument parsing (`parser.parse_args()`) and setting the port via `servomotor.set_serial_port_from_args(args)` happen *before* calling `servomotor.open_serial_port()`. This prevents the library from incorrectly falling back to reading `serial_device.txt`.
*   **Port Management:** Use `servomotor.open_serial_port()` at the beginning and `servomotor.close_serial_port()` at the end, typically within a `try...finally` block to ensure the port is closed even if errors occur.
*   **Clean State:** Start tests with `motor.system_reset()` followed by an appropriate delay (e.g., `time.sleep(1.0)`) to ensure a known starting condition.
*   **Safe Operation:** Use `motor.enable_mosfets()` before commanding movement and `motor.disable_mosfets()` during cleanup (in the `finally` block).
*   **Structured Tests:** Encapsulate test logic within functions (e.g., `def test_my_feature(motor_obj):`). Pass the initialized motor object to the test function.
*   **Standard Entry Point:** Use `if __name__ == "__main__":` to handle argument parsing, port setup, motor initialization, calling the main test function, and final port closing.
*   **Verification:** Employ helper functions (e.g., `wait_for_moves_to_complete`) and assertion functions (e.g., `verify_position`, `verify_timing`, or standard `assert`) to programmatically check expected outcomes.
*   **Clear Pass/Fail:** Conclude the test script by printing "PASSED" upon successful completion. Use assertions or explicit checks to detect failures and ensure the script exits with a non-zero status code on failure. Tests designed for continuous monitoring, data collection, or visualization might naturally omit a final PASS/FAIL message and exit code.
*   **Summarize Multi-Part Tests:** If a test performs multiple distinct checks or runs in a loop, consider tracking internal pass/fail counts and printing a summary at the end before the final "PASSED" message.

## Remaining Work (Test Framework Implementation)

1.  **Refactor Test Scripts:**
    *   Apply the best practices structure (argument parsing before port opening, `try...finally`, passing motor object) to the remaining affected test scripts:
        *   `test_set_velocity_to_specific_values.py`
    *   Review *all* non-obsolete tests to ensure they consistently exit with code 0 on success and non-zero on failure.
    *   Consider adding internal summaries for tests performing multiple checks.
2.  **Address `test_random_speed_stress.py`:**
    *   Decide whether to install the `paho-mqtt` dependency (`pip install paho-mqtt`) or modify the test to make MQTT optional/removable if not needed.
3.  **Verify Simulator Compatibility:**
    *   Investigate why tests like `test_communication_while_high_speed.py`, `test_get_comprehensive_position.py`, and `test_go_to_position.py` timed out or had read errors with the simulator. This might require adjustments to the tests or the simulator itself.
    *   Investigate the timeout for `test_fast_short_move_with_velocity.py` with the simulator.
4.  **Test Runner Refinement (Optional):**
    *   The `run_all_tests.py` script could be enhanced to parse `TEST_SUMMARY.md` more robustly to check the "Prints PASS/FAIL" column dynamically instead of hardcoding exceptions.
5.  **Run and Verify:** Execute `run_all_tests.py` against the simulator (and eventually real hardware) after fixes are applied to confirm all expected tests pass.
## Bootloader Testing

### Test Script: `test_bootloader.py` (Proposed)

This test script aims to verify the core functionalities of the STM32G031 bootloader accessed via RS485 communication. It should cover the following areas:

*   **Basic Communication & Identification:**
    *   Verify `DETECT_DEVICES_COMMAND` response (Unique ID, Alias).
    *   Verify `GET_PRODUCT_INFO_COMMAND` response (Model Code, Compatibility Code).
    *   Verify `GET_STATUS_COMMAND` response indicates "in bootloader" status.
*   **Alias Configuration:**
    *   Test setting a valid alias using `SET_DEVICE_ALIAS_COMMAND`.
    *   Verify the new alias is reported correctly via `DETECT_DEVICES_COMMAND`.
    *   Test setting invalid aliases and confirm failure.
*   **Firmware Upgrade:**
    *   Test uploading firmware pages using `FIRMWARE_UPGRADE_COMMAND`.
    *   Verify success with correct model/compatibility codes and payload size.
    *   Test failure cases: incorrect model code, incorrect compatibility code, incorrect payload size.
    *   After a simulated successful upgrade and reset, verify the device attempts to boot the application.
*   **Application Launch Control:**
    *   Verify the bootloader attempts to launch valid firmware after a delay on startup.
    *   Verify sending any command during this delay cancels the automatic launch.
*   **System Reset:**
    *   Test `SYSTEM_RESET_COMMAND` and verify the device resets.
*   **Error Handling:**
    *   Test sending commands with invalid CRC32 checksums and verify they are ignored.
    *   Test sending commands with incorrect payload sizes and verify failure.
*   **Test Mode (Optional):**
    *   If feasible, test `TEST_MODE_COMMAND` to trigger specific fatal errors and verify behavior.
### `test_bootloader.py` Status (as of 2025-04-22)

*   **Purpose:** Test STM32G031 bootloader commands via RS485.
*   **Implementation:** Uses `servomotor.communication` module functions (`send_command`, `get_response`) for packet handling, following standard test structure. Requires manual entry into bootloader mode before running.
*   **Tests Implemented:** Basic Communication & Identification, Alias Configuration.
*   **Current Issues:** Encountered `TimeoutError` during broadcast `DETECT_DEVICES` command, potentially due to timeout handling logic in `communication.send_command` for alias 0. Further investigation or workarounds within the test script needed. Other test sections (Firmware Upgrade, Reset, Error Handling) are placeholders.